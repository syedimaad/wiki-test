# Pipeline Architecture

- [https://viewer.diagrams.net/?tags=%7B%7D&highlight=0000ff&edit=\_blank&layers=1&nav=1&title=CZ-Prod-with-ES.drawio#R7V1tc6M4Ev41rrr74JR5xx8Tx8lOXTKb2cze7OyXKQKKzQaQD%2BPEmV9%2FAiMMkgzERkghM1M1Y4RwSHc%2F3a1HLWmkzcLtdeyslrfQA8FInXjbkXY5UlVNn5jov7TlddeiqIq9a1nEvpe37Rvu%2FZ8gb5zkrRvfA%2BtKxwTCIPFX1UYXRhFwk0qbE8fwpdrtEQbVn7pyFoBquHedgG795nvJctdqG5N9%2B2%2FAXyzxT1Ym%2BZ3QwZ3zhvXS8eBLqUmbj7RZDGGy%2BxRuZyBIpYflsnvu6sDd4sViECVtHliEtnn%2B9GPz6sDpl%2FM%2Fb%2B2Lb%2F5YwQp6doJN%2Fivnr5u8YhnEcBN5IP0aZaRdvCz9BNyvHDe9%2B4LUjtqWSRjktx%2F9IJjBAMbZs9psdnU1N1E7%2Fbr5b%2FAM4gRsS035618DGIIkfkVd8rvjQpa5NVlWfv2yV42i6HnjsqQXFSvMye1hUXz7XmToQy41tgTXmnXnat7X8eano17f%2FPjxfPk6tihxAQ9ZUH4J42QJFzBygvm%2B9QKZwiq9%2BxiA7XlqpKhtL%2BQJuto%2FdwPhKhftPyBJXnOIOJsEVgUPtn7yV%2Fr4mZFffc%2B%2FLP18uS1fvOKLCImg9FB6%2Bb18b%2F9YdoWfO6jMNdzELqg1OCNHsRMvQFLTc5pbZirOWuuIQeAk%2FnMVsCw9Z48ieTuvpQ4r6EfJuvTNd2nD3ui0adXmdAJlRHdFre2PPuxeYG9wxW%2FSygbrhcoLxSmGZzNOKC5cZhnFRacKirUOUMyWIGcBzu30b0cC1C3CxDSDFqBhMQSo2AYvAXKOI3PzcnI570qAGiFARhzRbJb8FG4GaPGV30X2tyP5tRAfMwpzFN%2BUEt91Jq5R6kfMAL3AxUOMPi3ST1%2FjDXpP1p1PIUro1pTk10kMn4oEUK1KGkfzcLtIk%2BCzxwC%2BuEsnTs7CDUpUxx50N2EmbabOuBo64Wp1m%2FYULDu3eenJtI9IlzpMjWy7khydTfHtA%2FkRurgDsY9%2BeRCfmDOxkr7j8yis2MY0ypQjjRqrxrRiitakPpGydKOuP59ECku15Eb%2BhhFALTf%2BOhmMW9BIBy7cLdDBrle3UHUKtt2bUzjBAWA2pMkBYNwJdwCTqtGZRr0DGBt27QOcPABG094D3MXA890EpLnEpZM4g3EDeGwqwg0wuRSFEm0fXmAPXbWCXYUfdtWW2JWEAxkXiTu2FKWJBTGMugc4YVelsPtfJ%2FA9Z4ddOtsfFJoVQxyat6H9ny9Py5tb5fsCaXb7%2B2MYjzURaD4BlBoXrFHYIIZkqkXIf%2BcU8of2KngrZgnfrpn1iFVru3PCq0bhdQajBGTvdQsSxxsCPmXJsVWdkjYl29NmeubG1VU3zkxpwTBNNYb0%2BDFMKs0QH8UwXSFxDoZgUgRmkGwt0TQ01tIBFZHN8%2FABeJ4fLQajJFU1GpU0ZSmJ11yBSnPdMyfyskQtHWOhcXU%2B3BoUWDTZyFjVrtXDDIarAGQfUz2g%2FzJsDEYfOjmoYeijiCe9AMMWkjK%2FbxosZ7cah9JW%2Fo2Ch9IkqWVpDXm5ZdT155SY07NpZcfwZ%2BR7SFH%2Bo39gXD1Id2G0IM2LUoZe3AV%2BoZKa5rd%2FoIZPaBAVh8Dz84A6hGEUnhZqwXLwSmaYnKVMLvsUf231xH1qbect8PyfYIdtT6UiUpg2aEhkg8ekDadbE2%2FSjjACm6QZOiLtSGMzG6oN67vzSQ6wyEtR5951Pn8eSoSxBfLobIGrtdnYYIjSbdWI355ncVMAzVOff7tHDfd08Ee%2FZEJIOlMDFlaUlpNU5Zc3OYG%2FiNClC6LMM16kIvNdJzjPb4S%2B52Wum6WQqjvvQA1j3ST0gPVS0oPJUAO3Gl2NJrDdn2MkbxCjuDV%2B2LhPgK7RGY5CNKKAohhKNvEV%2FDRCc%2BKrGHrjzcIdu7uZHHr4NxyFKIZs%2BqDZb4QQP%2FogCNF12QCii61oKS6%2BjyqUXPeDupzRbxzUaZ0Xo50GGHomYhfZ58%2B7WeiL2E%2FftKPUao3kk%2Fw4NLVKrblJ%2F3TEmhBUt8LKqVjBnFtOpasfBBlt%2BWnsu2RBBk0B75Bx44QPHj3YeFPlgPOwhsEmAeexm6sqa91f6UUQKmOMI0B0IrdSWEtaWLxiJwUHTFJnegRAuC4sxZ93kLEw69PtytLsqjt%2BCKOqDD%2BmtOUotCRTfK2hznJKkpN9lFlimdJBM518IGwWZ4Q3zgMI7uDaT3yYZoYPMElgyEgZE0g4C2zTaGThgvW6MZnMntnZ8uQs8yR7x2Ly9SJjhXQjJu1GdBZ3ofBLQU0hgRaTwxWf0dJl9Bacda1tcNalCs46o3CyxAhegwjETga0gYVpheCkipAsipvVj9n%2B4aOgS2%2BLrs5n%2Bk7TKc0zltF15QfJQOElG7oMMYPEYmJTLc9sNqwUliTfbbu7Cv5GSTBnSFRGMTBFW3IpWv%2BlaE6KtuVStERFKQNTtFwcuiF2gDlgRWtyUcKG4L1bBqxotWtFv419xOyhVc82miTbaNWwjfSa8Am5%2FkUnxg0Hiug64y3paoVP0SNAenXpGb53PpIb67IN5UTv7dBXfTNegfhe6ptVYjNBGReKY15CTOSpznsdOe2Vl0X3F3zwtj%2BNdqjIlU6aYhzFx9C1KldGaQplfYau686TytMSALqgZJ6X7qLWr8AJKVugKhLLyVNRZeVEGyf4FK02h2rVmVPDqlnN0JibHqebl3eUj5nEqgKTkZAx90yd8srILDFTV71PQ5ltEzJTskBIF%2FMOuQKLBIjN2hWcWwUWe%2Fe1YwiPHvf2P44E4Tf0KQ6TeC%2F72mmEzSmThj0pqd39ySf4rO9Ujhn%2F9FgLqL6X5MlkJE8SlwMaRNm21WCeZDmg1ceOqSad2P0qB9wlfQS1YtkmFdIM5jEDms0r6RPKpMhdr4R3iGneSqbznSJP0ym9IPtjVAOqWnUBnq20XKnNa0MWS%2F2FribQNKNLrlpbq77WdsDVgOQmnLZCh69e55BssbVDx9GF%2BYkje4hNmwZgHee8VtsyXMlKAm0xBUTSjFVa60109QBeY0oku%2BRxlA3FBER%2FPmMVW6JapUlbD%2FJe7LD7StMu7NBsKGrRzNr%2BnOxQ7LKRgdth54WwfdihbhoC7FCikr7WdviOMqrOZ5T6sEQTH9HNyRKZhKvYkXN1pc%2FgPGL3hcTH0dmEHdr1dmhNjbr%2BfDyiRS%2F%2BG2yRqHTje7Hk9H5Li3flBNrOuapy1JuS56k3HQOoiDgF0BZahDh4S5RjdvWtlkjlUX1M%2FQteLnmcIYrP0NuaYvf7R5822XD4%2BKIJPlKqOKBoVJ3bQ8ZoOmGadOz%2BzR5x%2FGjXk71F83tPYGTLYKxjNu2S9njz6nGokwYIH49WvAKheWpQjsAx1vRpxe6shjUzZJ2Z1ceimSntS2Z%2Fj3CpNXlky78%2Bw%2FRAFzd3JuhHTs4DBMT17vOt4wfrf1PGPaAKbYVc2cTaPJZXgTbz%2FFQxof%2FQijmO8G%2B7eWz3lQFHwZ9YWin4jIa68kXqYKAbOJxjDacCz2n44r0%2B%2FX71vy%2FW%2Bsn58vhPsHy4CASdXl7E%2FqldCf0T9ZTQf0TFOIHK0w5hbl49q4mAvlVlxvWGOW6V2A5S73iOm2mGgpl0wWcIdmOFrRNSMTw6eYZgQwSizhA8LQShyxjCpNw9DQ230ANpj%2F8D](https://viewer.diagrams.net/?tags=%7B%7D&highlight=0000ff&edit=_blank&layers=1&nav=1&title=CZ-Prod-with-ES.drawio#R7V1tc6M4Ev41rrr74JR5xx8Tx8lOXTKb2cze7OyXKQKKzQaQD%2BPEmV9%2FAiMMkgzERkghM1M1Y4RwSHc%2F3a1HLWmkzcLtdeyslrfQA8FInXjbkXY5UlVNn5jov7TlddeiqIq9a1nEvpe37Rvu%2FZ8gb5zkrRvfA%2BtKxwTCIPFX1UYXRhFwk0qbE8fwpdrtEQbVn7pyFoBquHedgG795nvJctdqG5N9%2B2%2FAXyzxT1Ym%2BZ3QwZ3zhvXS8eBLqUmbj7RZDGGy%2BxRuZyBIpYflsnvu6sDd4sViECVtHliEtnn%2B9GPz6sDpl%2FM%2Fb%2B2Lb%2F5YwQp6doJN%2Fivnr5u8YhnEcBN5IP0aZaRdvCz9BNyvHDe9%2B4LUjtqWSRjktx%2F9IJjBAMbZs9psdnU1N1E7%2Fbr5b%2FAM4gRsS035618DGIIkfkVd8rvjQpa5NVlWfv2yV42i6HnjsqQXFSvMye1hUXz7XmToQy41tgTXmnXnat7X8eano17f%2FPjxfPk6tihxAQ9ZUH4J42QJFzBygvm%2B9QKZwiq9%2BxiA7XlqpKhtL%2BQJuto%2FdwPhKhftPyBJXnOIOJsEVgUPtn7yV%2Fr4mZFffc%2B%2FLP18uS1fvOKLCImg9FB6%2Bb18b%2F9YdoWfO6jMNdzELqg1OCNHsRMvQFLTc5pbZirOWuuIQeAk%2FnMVsCw9Z48ieTuvpQ4r6EfJuvTNd2nD3ui0adXmdAJlRHdFre2PPuxeYG9wxW%2FSygbrhcoLxSmGZzNOKC5cZhnFRacKirUOUMyWIGcBzu30b0cC1C3CxDSDFqBhMQSo2AYvAXKOI3PzcnI570qAGiFARhzRbJb8FG4GaPGV30X2tyP5tRAfMwpzFN%2BUEt91Jq5R6kfMAL3AxUOMPi3ST1%2FjDXpP1p1PIUro1pTk10kMn4oEUK1KGkfzcLtIk%2BCzxwC%2BuEsnTs7CDUpUxx50N2EmbabOuBo64Wp1m%2FYULDu3eenJtI9IlzpMjWy7khydTfHtA%2FkRurgDsY9%2BeRCfmDOxkr7j8yis2MY0ypQjjRqrxrRiitakPpGydKOuP59ECku15Eb%2BhhFALTf%2BOhmMW9BIBy7cLdDBrle3UHUKtt2bUzjBAWA2pMkBYNwJdwCTqtGZRr0DGBt27QOcPABG094D3MXA890EpLnEpZM4g3EDeGwqwg0wuRSFEm0fXmAPXbWCXYUfdtWW2JWEAxkXiTu2FKWJBTGMugc4YVelsPtfJ%2FA9Z4ddOtsfFJoVQxyat6H9ny9Py5tb5fsCaXb7%2B2MYjzURaD4BlBoXrFHYIIZkqkXIf%2BcU8of2KngrZgnfrpn1iFVru3PCq0bhdQajBGTvdQsSxxsCPmXJsVWdkjYl29NmeubG1VU3zkxpwTBNNYb0%2BDFMKs0QH8UwXSFxDoZgUgRmkGwt0TQ01tIBFZHN8%2FABeJ4fLQajJFU1GpU0ZSmJ11yBSnPdMyfyskQtHWOhcXU%2B3BoUWDTZyFjVrtXDDIarAGQfUz2g%2FzJsDEYfOjmoYeijiCe9AMMWkjK%2FbxosZ7cah9JW%2Fo2Ch9IkqWVpDXm5ZdT155SY07NpZcfwZ%2BR7SFH%2Bo39gXD1Id2G0IM2LUoZe3AV%2BoZKa5rd%2FoIZPaBAVh8Dz84A6hGEUnhZqwXLwSmaYnKVMLvsUf231xH1qbect8PyfYIdtT6UiUpg2aEhkg8ekDadbE2%2FSjjACm6QZOiLtSGMzG6oN67vzSQ6wyEtR5951Pn8eSoSxBfLobIGrtdnYYIjSbdWI355ncVMAzVOff7tHDfd08Ee%2FZEJIOlMDFlaUlpNU5Zc3OYG%2FiNClC6LMM16kIvNdJzjPb4S%2B52Wum6WQqjvvQA1j3ST0gPVS0oPJUAO3Gl2NJrDdn2MkbxCjuDV%2B2LhPgK7RGY5CNKKAohhKNvEV%2FDRCc%2BKrGHrjzcIdu7uZHHr4NxyFKIZs%2BqDZb4QQP%2FogCNF12QCii61oKS6%2BjyqUXPeDupzRbxzUaZ0Xo50GGHomYhfZ58%2B7WeiL2E%2FftKPUao3kk%2Fw4NLVKrblJ%2F3TEmhBUt8LKqVjBnFtOpasfBBlt%2BWnsu2RBBk0B75Bx44QPHj3YeFPlgPOwhsEmAeexm6sqa91f6UUQKmOMI0B0IrdSWEtaWLxiJwUHTFJnegRAuC4sxZ93kLEw69PtytLsqjt%2BCKOqDD%2BmtOUotCRTfK2hznJKkpN9lFlimdJBM518IGwWZ4Q3zgMI7uDaT3yYZoYPMElgyEgZE0g4C2zTaGThgvW6MZnMntnZ8uQs8yR7x2Ly9SJjhXQjJu1GdBZ3ofBLQU0hgRaTwxWf0dJl9Bacda1tcNalCs46o3CyxAhegwjETga0gYVpheCkipAsipvVj9n%2B4aOgS2%2BLrs5n%2Bk7TKc0zltF15QfJQOElG7oMMYPEYmJTLc9sNqwUliTfbbu7Cv5GSTBnSFRGMTBFW3IpWv%2BlaE6KtuVStERFKQNTtFwcuiF2gDlgRWtyUcKG4L1bBqxotWtFv419xOyhVc82miTbaNWwjfSa8Am5%2FkUnxg0Hiug64y3paoVP0SNAenXpGb53PpIb67IN5UTv7dBXfTNegfhe6ptVYjNBGReKY15CTOSpznsdOe2Vl0X3F3zwtj%2BNdqjIlU6aYhzFx9C1KldGaQplfYau686TytMSALqgZJ6X7qLWr8AJKVugKhLLyVNRZeVEGyf4FK02h2rVmVPDqlnN0JibHqebl3eUj5nEqgKTkZAx90yd8srILDFTV71PQ5ltEzJTskBIF%2FMOuQKLBIjN2hWcWwUWe%2Fe1YwiPHvf2P44E4Tf0KQ6TeC%2F72mmEzSmThj0pqd39ySf4rO9Ujhn%2F9FgLqL6X5MlkJE8SlwMaRNm21WCeZDmg1ceOqSad2P0qB9wlfQS1YtkmFdIM5jEDms0r6RPKpMhdr4R3iGneSqbznSJP0ym9IPtjVAOqWnUBnq20XKnNa0MWS%2F2FribQNKNLrlpbq77WdsDVgOQmnLZCh69e55BssbVDx9GF%2BYkje4hNmwZgHee8VtsyXMlKAm0xBUTSjFVa60109QBeY0oku%2BRxlA3FBER%2FPmMVW6JapUlbD%2FJe7LD7StMu7NBsKGrRzNr%2BnOxQ7LKRgdth54WwfdihbhoC7FCikr7WdviOMqrOZ5T6sEQTH9HNyRKZhKvYkXN1pc%2FgPGL3hcTH0dmEHdr1dmhNjbr%2BfDyiRS%2F%2BG2yRqHTje7Hk9H5Li3flBNrOuapy1JuS56k3HQOoiDgF0BZahDh4S5RjdvWtlkjlUX1M%2FQteLnmcIYrP0NuaYvf7R5822XD4%2BKIJPlKqOKBoVJ3bQ8ZoOmGadOz%2BzR5x%2FGjXk71F83tPYGTLYKxjNu2S9njz6nGokwYIH49WvAKheWpQjsAx1vRpxe6shjUzZJ2Z1ceimSntS2Z%2Fj3CpNXlky78%2Bw%2FRAFzd3JuhHTs4DBMT17vOt4wfrf1PGPaAKbYVc2cTaPJZXgTbz%2FFQxof%2FQijmO8G%2B7eWz3lQFHwZ9YWin4jIa68kXqYKAbOJxjDacCz2n44r0%2B%2FX71vy%2FW%2Bsn58vhPsHy4CASdXl7E%2FqldCf0T9ZTQf0TFOIHK0w5hbl49q4mAvlVlxvWGOW6V2A5S73iOm2mGgpl0wWcIdmOFrRNSMTw6eYZgQwSizhA8LQShyxjCpNw9DQ230ANpj%2F8D){card-appearance="inline"}

# Involved Services

- AWS S3

- AWS EMR

- AWS Lambda

- AWS Event Bridge

# Pipeline in Detail

## Daily Runner

### Description

A single pyspark script which runs on a transient AWS EMR cluster,
triggered by AWS Lambda function which in-turn triggered by AWS Event
bridge based on a target CRON expression

### Process

#### Job Trigger -\> Lambda

- Trigger EMR job with required inputs (Target Date)

#### Candidate Generation

- Extract candidates from **Content Meta Data** table (from target S3
  partition folder) **~~ElasticSearch based on target date for available
  set of celebrities~~**

#### Candidate Filtering

- Filter candidates based on views, likes, shares or metadata *(Yet to
  be finalised)*

#### Inference

- Load latest ScaNN Model ~~Load latest celebrity embedding corpus~~

- Multi class classification on filtered set of candidates

- Store intermediate, metadata & final results to S3

### Involved Services

- Event Bridge

  - Triggers target lambda function based on specified cron expression

- Lambda

  - Triggers transient EMR Job using Boto3 python script

- EMR

  - Candidate generation and filtering

  - Runs batch inference job on final set of candidates

- S3

  - Extraction of candidates from underlying S3 path of **Content Meta
    data** table on AWS Athena

  - Storing complete set of faces, complete set of face embeddings along
    with un-identified face embeddings

  - Storing Intermediate processed data at specified location

  - Creation of Candidate Metadata (as JSON files with a specific
    Schema)

  - Storing final filtered dataset in the required format by QC team for
    external validation

- ~~Elastic Search~~

  - ~~Candidate Generation~~

### References

- [eb-run-lambda-schedule](https://docs.aws.amazon.com/eventbridge/latest/userguide/eb-run-lambda-schedule.html)

## New Celebrity Zone Batch Runner

### Description

A single pyspark script which runs on a transient AWS EMR cluster,
triggered by AWS Lambda function which in-turn triggered by an upload S3
event on specified folder in a bucket

### Process

#### Upload by External Team

- Ground Truth images upload at specified location

- Zone list (a dataset with zone-id, zone name and related
  keywords(optional)) upload at specified location, upon which lambda
  function gets triggered

#### Validation & Job Trigger -\> Lambda

- Validate uploaded zone list and ground truth images

- Trigger EMR job with required inputs

#### Ground Truth Embedding Generation & Training ScaNN

- Generate embeddings for uploaded ground truth faces

- Retrain ScaNN model with complete set of embeddings ~~Append these
  embeddings at the target S3 location~~

- Save trained model to target location on S3

#### Candidate Generation

- ~~Extract candidates from~~ **~~ElasticSearch~~** ~~based on uploaded
  zone list~~

- Extract candidates from unidentified pool of candidates

#### Candidate Filtering

- Filter out completely identified candidates (if any)

- Filter candidates based on views, likes, shares or metadata *(Yet to
  be finalised)*

#### Inference

- Load latest ScaNN Model ~~Load latest celebrity embedding corpus~~

- Multi class classification on final set of candidates

- Store intermediate, metadata & final results to S3

### Involved Services

- S3

  - Storing ground truth images and zone list

  - Storing computed ground truth embeddings

  - Extraction of candidates from unidentified candidates pool f daily
    runner

  - Storing complete set of faces, complete set of face embeddings along
    with un-identified face embeddings for new candidates

  - Deletion of unidentified face embedding if identified in current job
    run

  - Storing Intermediate processed data at specified location

  - Creation/Updation of Candidate Metadata (as JSON files with a
    specific Schema)

  - Storing final filtered dataset in the required format by QC team for
    external validation

- Lambda

  - Validation of ground truth images and zone list uploaded by External
    Team

  - Triggers transient EMR Job using Boto3 python script upon successful
    validation

- EMR

  - Ground truth embedding generation

  - Candidate generation and filtering

  - Runs batch inference job on final set of candidates

- ~~Elastic Search~~

  - ~~Candidate Generation~~

### References

- [s3-lambda-trigger-example](https://docs.aws.amazon.com/lambda/latest/dg/with-s3-example.html)

# S3 Touch Points

## Bucket with access to External Team

(Example -\> cz-external-bucket -\> **celebrity-zones-external**)

- Ground Truth Images

  - Uploaded to a folder, named with the convention {date of upload in
    yyyy-mm-dd}@{batch num}

  - Example:

    - s3://cz-external-bucket/ground-truth-images/{2022-09-08@1}/{zone-id}/img.png

- Zone List

  - Uploaded as a CSV File, named with the convention {date of upload in
    yyyy-mm-dd}@{batch num}.csv

  - Schema of CSV

    - Zone ID - String (UUID)

    - Zone Name - String

    - Keywords - String ('\|'(Pipe) separated words) (Optional)

  - Example:

    - s3://cz-external-bucket/zone-list/2022-09-08@1.csv

- Predicted Data

  - Final results from both runners which are to be validated

  - Example:

    - s3://cz-external-bucket/predicted-data/daily-runner/{2022-09-07}.csv

    - s3://cz-external-bucket/predicted-data/new-batch-runner/{2022-09-08@1}.csv

- Validated Data

  - Validation of predicted data with same name as predicted dataset

  - Example:

    - s3://cz-external-bucket/validated-data/daily-runner/{2022-09-07}.csv

    - s3://cz-external-bucket/validated-data/new-batch-runner/{2022-09-08@1}.csv

## Internal Meta Bucket

(Example -\> cz-internal-bucket -\>
**aiml-lab-datalakes/celebrity_zones**)

- Ground Truth Faces (Cropped faces from uploaded g-t images)

  - s3://cz-internal-bucket/ground-truth-faces/{zone-id}/face-{01}.jpg/png

- Ground Truth Embeddings

  - s3://cz-internal-bucket/ground-truth-faces/{zone-id}/face-{01}.json/proto/npy/npz

- Faces identified in a video

  - s3://cz-internal-bucket/candidates/faces/{content-uuid}/face-{01}.jpg

- Complete set of face embeddings identified in a video

  - s3://cz-internal-bucket/candidates/embeddings/{embedding-model-name}/complete/{content-uuid}/face-{01}.json/proto/npy/npz

- Unidentified face embeddings of a video

  - s3://cz-internal-bucket/candidates/embeddings/{embedding-model-name}/unidentified/{content-uuid}/face-{02}.json/proto/npy/npz

- Candidate Metadata

  - s3://cz-internal-bucket/candidates/metadata/{embedding-model-name}/{content_uuid}.json

- EMR Intermediate Data

  - Daily Runner

    - s3://cz-internal-bucket/intermediate-data/daily-runner/{yyyy}/{mm}/{dd}/\*.parquet

  - New Batch Runner

    - s3://cz-internal-bucket/intermediate-data/new-batch-runner/{yyyy}/{mm}/{dd}/{batch_num}/\*.parquet

- ScaNN

  - Contains saved scann models in respective embedding-model named
    folder as multiple versions

    - s3://cz-internal-bucket/intermediate-data/scann/inceptionresnet50/latest/

    - s3://cz-internal-bucket/intermediate-data/scann/adaface/v1/

- EMR Logs

  - Logs of each EMR Job (Both New Batch as well as Daily runner)

    - s3://cz-internal-bucket/intermediate-data/emr-logs/new-batch-runner/{yyyy}/{mm}/{dd}/{batch_num}/{cluster-id}

    - s3://cz-internal-bucket/intermediate-data/emr-logs/{yyyy}/{mm}/{dd}/{cluster-id}

# Important Schema

## Candidate Metadata

JSON Schema *(Yet to be finalised)*

- ~~content_uuid - String (Primary Identifier)~~

- ~~upload_ts - String (ISO 8601 Timestamp)~~

- ~~embedding_model_name - String~~

- num_detected_faces - Integer

- num_identified_faces - Integer

- unique_zones_identified - List\<String\>

- unique_zones_validated - List\<String\>

- identified_face_zone_distance_map - Dictionary *{face-01: {'zone-id':
  zone-id-1, 'distance': 0.25} ..}*

- detected_face_zone_metadata_map - Dictionary *{face-01: 0.34, ..}*

- ~~detected_face_zone_distance_map - Dictionary~~ *~~{face-01:
  {zone-id-1 : 0.25,..}, ..}~~*

- is_completely_classified - Boolean/Integer\
  (*True* if num_detected_faces == num_identified_faces else *False*)

# Miscellaneous

- All Lambda Logs will be stored on AWS CloudWatch by default (under a
  specific event group) ~~or on AWS DocumentDB~~

- All EMR Logs will be stored on internal S3 bucket

- Notifications & Alerts will be sent on GChat Space & on Email wherever
  required

- EMR Cluster's SPARK UI & Ganglia charts links will be sent on GChat
  Space

- ~~Historical Job run metrics will be stored on AWS DocumentDB and the
  same will be shown in Monitoring Dashboard~~

- Key Metrics calculated from Validation data will be stored on AWS
  DocumentDB and the same will be shown in Monitoring Dashboard

# To Do

- ~~Monitoring Dashboard Requirements~~

  - ~~Open Source like Metabase or Redash etc or Custom Dashboard using
    streamlit or plotly dash etc~~

  - ~~KPI's and other metrics required~~

- ~~Feature Store importance~~

  - *~~Feature store can be completely ignored upon conclusion on effect
    of performance by updating item docs on ElasticSearch~~*

- Implement Ground truth embedding folder locking strategy for parallel
  batch runs

  - Temp lock file strategy

- Batch job of candidates (\>100 & \>1000 views)
