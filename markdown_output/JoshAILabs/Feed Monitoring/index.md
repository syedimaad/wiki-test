### Funnel View

+-----------------+-----------------+-----------------+-----------------+
| **Inference     | **P0 Metric -   | **Quality       |                 |
| Funnel**        | Availability**  | Metric**        |                 |
+-----------------+-----------------+-----------------+-----------------+
|                 |                 |                 |                 |
+-----------------+-----------------+-----------------+-----------------+
| Total Request   | Total           |                 |                 |
|                 | users/request   |                 |                 |
|                 | count           |                 |                 |
+-----------------+-----------------+-----------------+-----------------+
|                 |                 |                 |                 |
+-----------------+-----------------+-----------------+-----------------+
| User history    | Redis + Bloom   | distribution -  |                 |
|                 | Filter history  | size of history |                 |
|                 | availability    |                 |                 |
+-----------------+-----------------+-----------------+-----------------+
| recent_k        | recent_k        | distribution of |                 |
|                 | availability /  | count of each   |                 |
|                 | size per        | metric - likes, |                 |
|                 | interaction     | shares, skip,   |                 |
|                 | type            | pcc98           |                 |
+-----------------+-----------------+-----------------+-----------------+
| User+Item Meta  | cache           |                 |                 |
|                 | hits/misses,    |                 |                 |
|                 | timeouts        |                 |                 |
+-----------------+-----------------+-----------------+-----------------+
| LTHM clusters   | LTHM            | Cluster size    |                 |
|                 | availability /  | distribution    |                 |
|                 | type of cluster |                 |                 |
|                 | / size          |                 |                 |
+-----------------+-----------------+-----------------+-----------------+
| Follow history  | Follow history  |                 |                 |
|                 | availability    |                 |                 |
+-----------------+-----------------+-----------------+-----------------+
|                 |                 |                 |                 |
+-----------------+-----------------+-----------------+-----------------+
| Retrieval       | Time            | PPR             | Thematic score\ |
| Sources         | outs/Errors;    |                 | Size Delta\     |
|                 | Items           |                 | Item age        |
|                 | availability;   |                 | distribution\   |
|                 | quota           |                 | Language        |
|                 |                 |                 | Distribution\   |
|                 |                 |                 | Average video   |
|                 |                 |                 | length          |
+-----------------+-----------------+-----------------+-----------------+
|                 |                 | MTL             | Thematic score\ |
|                 |                 |                 | Model Loss /    |
|                 |                 |                 | Delta from the  |
|                 |                 |                 | last one\       |
|                 |                 |                 | Item age        |
|                 |                 |                 | distribution\   |
|                 |                 |                 | Size delta\     |
|                 |                 |                 | Average video   |
|                 |                 |                 | length          |
+-----------------+-----------------+-----------------+-----------------+
|                 |                 | ColdStart       | Thematic score\ |
|                 |                 |                 | Item age        |
|                 |                 |                 | distribution,   |
|                 |                 |                 | Lang            |
|                 |                 |                 | Distribution,\  |
|                 |                 |                 | Size delta\     |
|                 |                 |                 | Average video   |
|                 |                 |                 | length          |
+-----------------+-----------------+-----------------+-----------------+
|                 |                 | HNSW            | Thematic score\ |
|                 |                 |                 | Item age        |
|                 |                 |                 | distribution,   |
|                 |                 |                 | Lang            |
|                 |                 |                 | Distribution,\  |
|                 |                 |                 | Size delta\     |
|                 |                 |                 | Average video   |
|                 |                 |                 | length          |
+-----------------+-----------------+-----------------+-----------------+
|                 |                 |                 |                 |
+-----------------+-----------------+-----------------+-----------------+
|                 |                 | Overfetch       | Reasons and     |
|                 |                 |                 | Sets being      |
|                 |                 |                 | formed          |
+-----------------+-----------------+-----------------+-----------------+
|                 |                 |                 |                 |
+-----------------+-----------------+-----------------+-----------------+
| Ranker          | Ranker          | Ranker Score    | Selection Rate  |
|                 | availability    | distribution    | of Retrieval    |
|                 | out of total    | (Cold, Warm)    | Source\         |
|                 | requests        |                 | Average         |
|                 |                 |                 | candidates      |
|                 |                 |                 | count (by       |
|                 |                 |                 | session type -  |
|                 |                 |                 | ex:             |
|                 |                 |                 | notification)\  |
|                 |                 |                 | Ranking         |
|                 |                 |                 | training        |
|                 |                 |                 | metrics (imp    |
|                 |                 |                 | ones)\          |
|                 |                 |                 | Average video   |
|                 |                 |                 | length\         |
|                 |                 |                 | Uniqueness of   |
|                 |                 |                 | items based on  |
|                 |                 |                 | different       |
|                 |                 |                 | taxonomy or     |
|                 |                 |                 | counts\*\*      |
+-----------------+-----------------+-----------------+-----------------+
|                 |                 |                 |                 |
+-----------------+-----------------+-----------------+-----------------+
| Final Serving   | Total served %  | Thematic Score  | Distribution of |
| (Blending)      | & count         |                 | Retrieval       |
|                 |                 |                 | Source\         |
|                 |                 |                 | Average         |
|                 |                 |                 | candidates      |
|                 |                 |                 | count\          |
|                 |                 |                 | Candidate level |
|                 |                 |                 | blending score  |
|                 |                 |                 | aggregation     |
+-----------------+-----------------+-----------------+-----------------+
|                 |                 |                 |                 |
+-----------------+-----------------+-----------------+-----------------+
| Java Filters    | Served Items to |                 |                 |
|                 | End User (valid |                 |                 |
|                 | items, served   |                 |                 |
|                 | items)          |                 |                 |
+-----------------+-----------------+-----------------+-----------------+
|                 | Offline Cache   |                 |                 |
+-----------------+-----------------+-----------------+-----------------+
|                 | Back Fill       |                 |                 |
|                 | serving         |                 |                 |
+-----------------+-----------------+-----------------+-----------------+
| Cache Validate  |                 |                 |                 |
+-----------------+-----------------+-----------------+-----------------+

### Alert Conditions ( Day Level)

+--------------------+-----------------------------------------------------------------------------------------------------------------------------------+----------------+-------------------+
| **Type**           | **Alert Condition**                                                                                                               | **Delta /      | **Message**       |
|                    |                                                                                                                                   | Percentage     |                   |
|                    |                                                                                                                                   | Change /       |                   |
|                    |                                                                                                                                   | Null**         |                   |
+--------------------+-----------------------------------------------------------------------------------------------------------------------------------+----------------+-------------------+
| **REQUESTS DATA**  | is_coldstart == Nan AND percentage share across is greater than 0.02 %                                                            | Delta (Perc    | Percentage share  |
|                    |                                                                                                                                   | Share)         | where             |
|                    |                                                                                                                                   |                | "is_coldstart"    |
|                    |                                                                                                                                   |                | flag is missing,  |
|                    |                                                                                                                                   |                | is up by X        |
|                    |                                                                                                                                   |                | percentage        |
|                    |                                                                                                                                   |                | points.           |
|                    |                                                                                                                                   |                |                   |
|                    |                                                                                                                                   |                | Threshold is set  |
|                    |                                                                                                                                   |                | at 0.02%          |
|                    |                                                                                                                                   |                |                   |
|                    |                                                                                                                                   |                | This error means  |
|                    |                                                                                                                                   |                | user history is   |
|                    |                                                                                                                                   |                | not correctly     |
|                    |                                                                                                                                   |                | understood        |
+--------------------+-----------------------------------------------------------------------------------------------------------------------------------+----------------+-------------------+
|                    | for non cold start, delta is \>= -3%                                                                                              | Delta          | num_requests for  |
|                    |                                                                                                                                   |                | non cold start    |
|                    |                                                                                                                                   |                | items is X%       |
|                    |                                                                                                                                   |                | lesser than       |
|                    |                                                                                                                                   |                | \<previous_date\> |
|                    |                                                                                                                                   |                |                   |
|                    |                                                                                                                                   |                | This is a traffic |
|                    |                                                                                                                                   |                | is below          |
|                    |                                                                                                                                   |                | threshold alert.  |
+--------------------+-----------------------------------------------------------------------------------------------------------------------------------+----------------+-------------------+
| **LTHM:            | `st_data_count/total_data_count` \< 70%                                                                                           | Delta (Perc    | Short term        |
| st_data_count**    |                                                                                                                                   | Share)         | Medoids (14 days) |
|                    |                                                                                                                                   |                | are available for |
|                    |                                                                                                                                   |                | X% requests       |
|                    |                                                                                                                                   |                | today. Alert set  |
|                    |                                                                                                                                   |                | when availability |
|                    |                                                                                                                                   |                | is less than 70%  |
+--------------------+-----------------------------------------------------------------------------------------------------------------------------------+----------------+-------------------+
| **LTHM:            | `mt_data_count/total_data_count` \< 75%                                                                                           | Delta (Perc    | Medium term       |
| mt_data_count**    |                                                                                                                                   | Share)         | Medoids(30 days)  |
|                    |                                                                                                                                   |                | are available for |
|                    |                                                                                                                                   |                | X% requests       |
|                    |                                                                                                                                   |                | today. Alert set  |
|                    |                                                                                                                                   |                | when availability |
|                    |                                                                                                                                   |                | is less than 75%  |
+--------------------+-----------------------------------------------------------------------------------------------------------------------------------+----------------+-------------------+
| **RETRIEVAL DATA** | `dnn_mtl_model_gt5_p90_v1_hi` \> +/- 25%                                                                                          | PC             | \<Algo\> Serving  |
|                    |                                                                                                                                   |                | share changed by  |
|                    |                                                                                                                                   |                | -/+X% compared to |
|                    |                                                                                                                                   |                | \<prev_date\>     |
+--------------------+-----------------------------------------------------------------------------------------------------------------------------------+----------------+-------------------+
|                    | `content_based_ppr` \> +/- 25%                                                                                                    | PC             |                   |
+--------------------+-----------------------------------------------------------------------------------------------------------------------------------+----------------+-------------------+
|                    | `'v2v_recent_watch_coldstart_content','v2v_blip_most_recent_like','v2v_blip_hist_coldstart_content','u2v_blip_coldstart_content'` | PC             |                   |
|                    | \> +/- 25%                                                                                                                        |                |                   |
+--------------------+-----------------------------------------------------------------------------------------------------------------------------------+----------------+-------------------+
|                    | `v2v_recent_watch`\> +/- 25%                                                                                                      | PC             |                   |
+--------------------+-----------------------------------------------------------------------------------------------------------------------------------+----------------+-------------------+
| **BLENDING**       | Percentage share of retry-failed \> 0.21%                                                                                         | Delta (Perc    | retry_failed for  |
|                    |                                                                                                                                   | Share)         | blending is X%,   |
|                    |                                                                                                                                   |                |                   |
|                    |                                                                                                                                   |                | alert threshold   |
|                    |                                                                                                                                   |                | set at 0.21%      |
+--------------------+-----------------------------------------------------------------------------------------------------------------------------------+----------------+-------------------+
| **JAVA FILTER**    | request_count change \> -3%                                                                                                       | PC             | request_count     |
|                    |                                                                                                                                   |                | changed by X%     |
|                    |                                                                                                                                   |                | compared to       |
|                    |                                                                                                                                   |                | \<previous_date\> |
|                    |                                                                                                                                   |                |                   |
|                    |                                                                                                                                   |                | Alert threshold   |
|                    |                                                                                                                                   |                | set at -3%        |
+--------------------+-----------------------------------------------------------------------------------------------------------------------------------+----------------+-------------------+
| **RETRIEVAL :      | if distribution for any lang_code ==0                                                                                             | Null           | This \<lang\>     |
| MTL**              |                                                                                                                                   |                | process has       |
|                    |                                                                                                                                   |                | failed , has 0    |
|                    |                                                                                                                                   |                | content for MTL   |
|                    |                                                                                                                                   |                | on \<date, last   |
|                    |                                                                                                                                   |                | run time\>        |
+--------------------+-----------------------------------------------------------------------------------------------------------------------------------+----------------+-------------------+
|                    | if distribution of age_bucket ==0 (except for 91-120, 121+)                                                                       | Null           | Age content is    |
|                    |                                                                                                                                   |                | zero for          |
|                    |                                                                                                                                   |                | \<Buckets\> for   |
|                    |                                                                                                                                   |                | MTL \* Language   |
|                    |                                                                                                                                   |                | \* date,last run  |
|                    |                                                                                                                                   |                | time              |
+--------------------+-----------------------------------------------------------------------------------------------------------------------------------+----------------+-------------------+
| **RETRIEVAL :      | if distribution for any lang_code ==0                                                                                             | Null           | Language          |
| PPR**              |                                                                                                                                   |                | distribution for  |
|                    |                                                                                                                                   |                | \<Bucket\> for    |
|                    |                                                                                                                                   |                | PPR is zero       |
+--------------------+-----------------------------------------------------------------------------------------------------------------------------------+----------------+-------------------+
|                    | if distribution of age_bucket ==0 (except for 91-120, 121+)                                                                       | Null           | Age Distribution  |
|                    |                                                                                                                                   |                | is zero for       |
|                    |                                                                                                                                   |                | \<Buckets\> for   |
|                    |                                                                                                                                   |                | PPR               |
+--------------------+-----------------------------------------------------------------------------------------------------------------------------------+----------------+-------------------+
| **RETRIEVAL : Cold | if distribution for any lang_code ==0                                                                                             | Null           | Language          |
| Start**            |                                                                                                                                   |                | distribution for  |
|                    |                                                                                                                                   |                | \<lang\> for Cold |
|                    |                                                                                                                                   |                | Start is zero     |
+--------------------+-----------------------------------------------------------------------------------------------------------------------------------+----------------+-------------------+
|                    | if distribution of age_bucket ==0 (except for 91-120, 121+)                                                                       | Null           | Age Distribution  |
|                    |                                                                                                                                   |                | is zero for       |
|                    |                                                                                                                                   |                | \<Buckets\> for   |
|                    |                                                                                                                                   |                | Cold Start        |
+--------------------+-----------------------------------------------------------------------------------------------------------------------------------+----------------+-------------------+
| **RETRIEVAL :      | if distribution for any lang_code ==0                                                                                             | Null           | Language          |
| V2V**              |                                                                                                                                   |                | distribution for  |
|                    |                                                                                                                                   |                | \<lang\> for V2V  |
|                    |                                                                                                                                   |                | is zero           |
+--------------------+-----------------------------------------------------------------------------------------------------------------------------------+----------------+-------------------+
|                    | if distribution of age_bucket ==0 (except for 91-120, 121+)                                                                       | Null           | Age Distribution  |
|                    |                                                                                                                                   |                | is zero for       |
|                    |                                                                                                                                   |                | \<Buckets\> for   |
|                    |                                                                                                                                   |                | V2v               |
+--------------------+-----------------------------------------------------------------------------------------------------------------------------------+----------------+-------------------+
| **CACHE_VALIDATE** | if percentage change of total_requests \>3%                                                                                       | PC             | cache_validate is |
|                    |                                                                                                                                   |                | higher by X% from |
|                    |                                                                                                                                   |                | the               |
|                    |                                                                                                                                   |                | \<previous_date\> |
|                    |                                                                                                                                   |                |                   |
|                    |                                                                                                                                   |                | Alert threshold   |
|                    |                                                                                                                                   |                | set at 3%         |
+--------------------+-----------------------------------------------------------------------------------------------------------------------------------+----------------+-------------------+
| **USER_N_FOLLOW    | **follow_cache**\                                                                                                                 | Delta          | avg_hitratio for  |
| :**                | avg_hitratio \< 0.06                                                                                                              |                | `follow_cache` is |
|                    |                                                                                                                                   |                | X,                |
|                    |                                                                                                                                   |                |                   |
|                    |                                                                                                                                   |                | Alert threshold   |
|                    |                                                                                                                                   |                | set at 0.06       |
+--------------------+-----------------------------------------------------------------------------------------------------------------------------------+----------------+-------------------+
|                    | **bf_his_cache**                                                                                                                  | Delta          | avg_hitratio for  |
|                    |                                                                                                                                   |                | `bf_his_cache` is |
|                    | avg_hitratio \< 0.75                                                                                                              |                | X,                |
|                    |                                                                                                                                   |                |                   |
|                    |                                                                                                                                   |                | Alert threshold   |
|                    |                                                                                                                                   |                | set at 0.75       |
+--------------------+-----------------------------------------------------------------------------------------------------------------------------------+----------------+-------------------+
| **BACKFILL**       | fallback_percent \> 0.2                                                                                                           | Delta          | fallback_percent  |
|                    |                                                                                                                                   |                | on backfill       |
|                    |                                                                                                                                   |                | increased by X    |
|                    |                                                                                                                                   |                | percentage        |
|                    |                                                                                                                                   |                | points.           |
|                    |                                                                                                                                   |                |                   |
|                    |                                                                                                                                   |                | Alert threshold   |
|                    |                                                                                                                                   |                | set at 0.2%       |
+--------------------+-----------------------------------------------------------------------------------------------------------------------------------+----------------+-------------------+
| recent_k - Non     | share of like \> 0.2984                                                                                                           | Delta (Perc    | \[ Non Cold Start |
| Cold Start         |                                                                                                                                   | Share)         | \]: Recent_k      |
|                    |                                                                                                                                   |                | Likes is not      |
|                    |                                                                                                                                   |                | available for X%  |
|                    |                                                                                                                                   |                | requests today.   |
|                    |                                                                                                                                   |                | Alert set when    |
|                    |                                                                                                                                   |                | un-availability   |
|                    |                                                                                                                                   |                | is more than      |
|                    |                                                                                                                                   |                | 29.84%            |
+--------------------+-----------------------------------------------------------------------------------------------------------------------------------+----------------+-------------------+
|                    | share of share\> 0.4614                                                                                                           | Delta (Perc    | \[ Non Cold Start |
|                    |                                                                                                                                   | Share)         | \]: Recent_k      |
|                    |                                                                                                                                   |                | Shares is not     |
|                    |                                                                                                                                   |                | available for X%  |
|                    |                                                                                                                                   |                | requests today.   |
|                    |                                                                                                                                   |                | Alert set when    |
|                    |                                                                                                                                   |                | un-availability   |
|                    |                                                                                                                                   |                | is more than      |
|                    |                                                                                                                                   |                | 46.25%            |
+--------------------+-----------------------------------------------------------------------------------------------------------------------------------+----------------+-------------------+
|                    | share of skip \> 0.0429                                                                                                           | Delta (Perc    | \[ Non Cold Start |
|                    |                                                                                                                                   | Share)         | \]: Recent_k      |
|                    |                                                                                                                                   |                | Skips is not      |
|                    |                                                                                                                                   |                | available for X%  |
|                    |                                                                                                                                   |                | requests today.   |
|                    |                                                                                                                                   |                | Alert set when    |
|                    |                                                                                                                                   |                | un-availability   |
|                    |                                                                                                                                   |                | is more than      |
|                    |                                                                                                                                   |                | 4.29%             |
+--------------------+-----------------------------------------------------------------------------------------------------------------------------------+----------------+-------------------+
|                    | share of pcc98 \> 0.0575                                                                                                          | Delta (Perc    | \[ Non Cold Start |
|                    |                                                                                                                                   | Share)         | \]: Recent_k      |
|                    |                                                                                                                                   |                | PCC98 is not      |
|                    |                                                                                                                                   |                | available for X%  |
|                    |                                                                                                                                   |                | requests today.   |
|                    |                                                                                                                                   |                | Alert set when    |
|                    |                                                                                                                                   |                | un-availability   |
|                    |                                                                                                                                   |                | is more than      |
|                    |                                                                                                                                   |                | 5.75%             |
+--------------------+-----------------------------------------------------------------------------------------------------------------------------------+----------------+-------------------+

## Realtime Monitoring

Thresholds

+-----------------------------------------+-----------------+---------------------------------------+---------------------------------------------------------------------------------------------------------------------------+
| **Metric**                              | **Source**      | **Conditions**                        | **Message**                                                                                                               |
+-----------------------------------------+-----------------+---------------------------------------+---------------------------------------------------------------------------------------------------------------------------+
| `internal_function_latency_timebudget`  | SUMO            | 1.  avg ts in last 15 min \> 25ms &   | `timebudget_latency: avg_ts:{value} (15min) is greater than p95:{rvalue} (5hr) for {metric}`                              |
|                                         |                 |     avg ts in last 3hr \>25ms         |                                                                                                                           |
|                                         |                 |                                       |                                                                                                                           |
|                                         |                 | 2.  avg ts in last 15 mins \> p95 ts  |                                                                                                                           |
|                                         |                 |     in last 3 hr\                     |                                                                                                                           |
|                                         |                 |     AND\                              |                                                                                                                           |
|                                         |                 |     avg ts in last 15 mins \> 1.5 \*  |                                                                                                                           |
|                                         |                 |     avg ts in last 3 hr               |                                                                                                                           |
+-----------------------------------------+-----------------+---------------------------------------+---------------------------------------------------------------------------------------------------------------------------+
| `feed_infer_internal_functions_latency` | SUMO            | 1.  avg ts in last 15 min \> 25ms &   | `feed_infer_latency: avg_ts:{value} (15min) is greater than provided threshold ({value}%) of {value} (5hr) for {metric]}` |
|                                         |                 |     avg ts in last 3hr \>25ms         |                                                                                                                           |
|                                         |                 |                                       |                                                                                                                           |
|                                         |                 | 2.  avg ts in last 15 mins \> 1.5 \*  |                                                                                                                           |
|                                         |                 |     avg ts in last 3hr                |                                                                                                                           |
+-----------------------------------------+-----------------+---------------------------------------+---------------------------------------------------------------------------------------------------------------------------+
| `external_services_timeouts`            | SUMO            | if count (15mins) is \> 2500 for PPR  | `timeouts: count {value} is greater than 2500 for {service_url}`                                                          |
|                                         |                 |                                       |                                                                                                                           |
|                                         |                 | if count (15mins) \> 2000 for rest of |                                                                                                                           |
|                                         |                 | the services (scann, graph_db)        |                                                                                                                           |
+-----------------------------------------+-----------------+---------------------------------------+---------------------------------------------------------------------------------------------------------------------------+
| `latency_external_services`             | SUMO            | 1.  time p99 in last 15 min \> 25ms & | `latency_external_services: time_p99:{value} (15min) is greater than p99:{value} (5hr) for {service_name}`                |
|                                         |                 |     time p99 in last 3hr \>25ms       |                                                                                                                           |
|                                         |                 |                                       |                                                                                                                           |
|                                         |                 | 2.  time p99 in last 15 mins \> time  |                                                                                                                           |
|                                         |                 |     p99 in last 3hr\                  |                                                                                                                           |
|                                         |                 |     AND\                              |                                                                                                                           |
|                                         |                 |     time p99 in last 15 mins \> 1.5   |                                                                                                                           |
|                                         |                 |     \* time p99 in last 3hr           |                                                                                                                           |
+-----------------------------------------+-----------------+---------------------------------------+---------------------------------------------------------------------------------------------------------------------------+
| Blender score                           | Grafana         | If the p99 score drift in last 15     | `{Metric} outside the defined range of +/-20%}`                                                                           |
|                                         |                 | min, compared to last 3 hr, is        |                                                                                                                           |
|                                         |                 | outside +/- 20%                       |                                                                                                                           |
+-----------------------------------------+-----------------+---------------------------------------+---------------------------------------------------------------------------------------------------------------------------+
| Ranker Score                            | Grafana         | If the p99 score drift in last 15     | `{Metric} outside the defined range of +/-40%}`                                                                           |
|                                         |                 | min, compared to last 3 hr, is        |                                                                                                                           |
|                                         |                 | outside +/- 40%                       |                                                                                                                           |
+-----------------------------------------+-----------------+---------------------------------------+---------------------------------------------------------------------------------------------------------------------------+
| Candidate Algo %age change              | Grafana         | if fraction drift for each algorithm  | `{Metric} outside the defined range of +/-15%}`                                                                           |
|                                         |                 | in last 15 min, compared to last 3    |                                                                                                                           |
|                                         |                 | hr, is outside +/- 15%                |                                                                                                                           |
+-----------------------------------------+-----------------+---------------------------------------+---------------------------------------------------------------------------------------------------------------------------+
| Triton fallback                         | Grafana         | if fallback percentage \> 0.2%        | `{Metric} gretaer than 0.2%}`                                                                                             |
+-----------------------------------------+-----------------+---------------------------------------+---------------------------------------------------------------------------------------------------------------------------+
| Candidate Version                       |                 | [TBD]{style="color: rgb(255,86,48);"} |                                                                                                                           |
+-----------------------------------------+-----------------+---------------------------------------+---------------------------------------------------------------------------------------------------------------------------+
| Candidate Likes, Shares                 |                 | [TBD]{style="color: rgb(255,86,48);"} |                                                                                                                           |
+-----------------------------------------+-----------------+---------------------------------------+---------------------------------------------------------------------------------------------------------------------------+
